<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="{{ url_for('static', filename='js/scoresArray.js') }}"></script>

    <title>Duck Page</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            flex-direction: column;
        }

        .container {
            width: 300px;
            margin: 0 auto;
            text-align: center;
        }

        .card {
            background-color: #ffffff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin: 20px auto;
        }

        .card img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 10px 0;
        }

        .card h2 {
            font-size: 24px;
            color: #333;
            margin: 10px 0;
        }

        .play-button,
        .restart-button,
        .finish-button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .start-button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 2px;
        }

        .play-button {
            background-color: #4c98af;
        }

        .record-button {
            background-color: #4caf50;
        }

        .restart-button {
            background-color: #ff9800;
            display: none;
        }

        .exit-button {
            background-color: #4caf50;
        }

        .finish-button {
            background-color: #f44336;
            /* Red color for Finish button */
            display: block;
            /* Ensures the button behaves like a block element */
            width: 30%;
            /* Full width for better usability */
        }

        .progress-bar {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin-top: 20px;
        }

        .progress {
            width: 0%;
            height: 20px;
            background-color: #4caf50;
            border-radius: 10px;
            transition: width 0.5s;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            gap: 2px;
            flex-wrap: nowrap;
        }

        .controls button {
            flex: 1;
            min-width: 60px;
            max-width: 80px;
            height: 30px;
            padding: 3px;
            font-size: 12px;
        }

        @media (max-width: 480px) {
            .controls {
                justify-content: center;
                gap: 1px;
            }

            .controls button {
                flex-basis: auto;
                min-width: 50px;
                max-width: 70px;
                height: 28px;
            }
        }

        .record {
            height: 32px !important;
            transform: translateY(-2px)
        }


        .hide {
            visibility: hidden;
        }

        .win {
            color: green;
        }

        .lose {
            color: red;
        }
    </style>
    </style>
</head>

<body>
    <div class="container">
        <h1>Duck</h1>
        <div class="card">
            <h2>This is a duck</h2>
            <img src="../static/images/duck.png" alt="Duck Image" />
        </div>
        <div class="progress-bar">
            <div class="progress"></div>
        </div>


        <div class="controls">
            <button id='previous-button' class="exit-button start-button">Previous</button>

            <audio id="catSound" src="../static/audiofiles/animal_game/level3/this is a cat.mp3"></audio>

            <button class="play-button" onclick="document.getElementById('catSound').play()">Play</button> <button
                class="action record-button start-button" onclick="startRecognition()">Record</button>
            <button class="restart-button record" onclick="playRecording()">Play
                Recording</button>
            <button id='next-button' class="exit-button start-button">Next</button>
        </div>

        <!-- New Finish Button -->
        <!-- New Finish Button -->
        <div style="display: flex; justify-content: center;">

            <button class="finish-button" onclick="finishGame()">Finish</button>
        </div>

        <div class="progress-bar" id="progress-bar">
            <div class="progress"></div>
        </div>
        <div>
            <h3>Your Result:</h3>
            <h4 id="result" class="hide"></h4>
        </div>
    </div>

    <script>

        var win = false;
        let audioPlayed = false;

        let recordedAudioBlob; // This will store the blob from client recording
        const audioFileName = 'output.wav'; // Default filename for recordings

        // const utterance = new SpeechSynthesisUtterance('This is a duck');


        let nextButtonClicked = false
        let previousButtonClicked = false
        let gameplayed = false
        // Function to record audio on the server
        function recordAudioToServer(duration) {
            return fetch('http://127.0.0.1:5001/record', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    filename: audioFileName,
                    duration: duration // Duration of the recording in seconds
                }),
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data.message); // Log success message
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function playRecording() {
            const audioUrl = `http://127.0.0.1:5001/audio/${audioFileName}?t=${new Date().getTime()}`; // Append the current timestamp
            const audioPlayback = new Audio(audioUrl);
            audioPlayback.play();
            console.log("Playing recorded audio...");
        }

        function startRecognition() {

            const recordDuration = 5; // Set the duration for recording in seconds
            recordAudioToServer(recordDuration).then(() => {
                document.getElementById("action").innerHTML = "Record"; // Reset button text after recording
            });
            gameplayed = true
            var recordButton = document.querySelector(".record-button");
            var result = document.getElementById("result");
            let recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'en-US';
            recognition.interimResults = false;

            recognition.onstart = function () {
                recordButton.textContent = "Recording...";
            };

            recognition.onresult = function (event) {
                var transcript = event.results[0][0].transcript.toLowerCase();

                console.log("You said: " + transcript);

                let progressBar = document.querySelector(".progress");

                if (transcript.includes("this is a duck")) {
                    win = true;
                    score = 100;  // Set your score
                    result.innerHTML = "Score 100: You win!";
                    result.classList.remove("hide");
                    result.classList.remove("lose");
                    result.classList.add("win");

                    // Turn the progress bar green
                    progressBar.style.width = "100%";
                    progressBar.style.backgroundColor = "green";
                } else {
                    score = 0;  // Set your score
                    result.innerHTML = "Game Over: Score 0";
                    result.classList.remove("hide");
                    result.classList.remove("win");
                    result.classList.add("lose");

                    // Turn the progress bar red
                    progressBar.style.width = "100%";
                    progressBar.style.backgroundColor = "red";
                }

                // Store the score in localStorage
                localStorage.setItem('duck_score', score);

                // Show the Play Recording button after the game finishes
                document.querySelector(".restart-button").style.display = "block";
                recordButton.textContent = "Record";
            };

            recognition.onerror = function (event) {
                recordButton.textContent = "Record";
                result.innerHTML = "Error occurred: " + event.error;
                result.classList.remove("hide");
                result.classList.remove("win");
                result.classList.add("lose");

                // Turn the progress bar red in case of an error
                let progressBar = document.querySelector(".progress");
                progressBar.style.width = "100%";
                progressBar.style.backgroundColor = "red";

                // Show the Play Recording button if an error occurs
                document.querySelector(".restart-button").style.display = "block";
            };

            recognition.onend = function () {
                recordButton.textContent = "Record";
            };

            recognition.start();
        }

        // function resetGame() {
        //     var result = document.getElementById("result");
        //     result.classList.add("hide");
        //     result.innerHTML = "";

        //     // Reset the progress bar
        //     let progressBar = document.querySelector(".progress");
        //     progressBar.style.width = "0%";
        //     progressBar.style.backgroundColor = "#4caf50"; // Default color

        //     document.querySelector(".restart-button").style.display = "none"; // Hide the Play Recording button
        //     // Replay the sound to start the game again
        // }
        function finishGame() {
            // Redirect to the desired page or functionality for finishing the game
            window.location.href = "finish_animal_level3"; // Change as needed
        }
        function getCurrentPageName() {
            const path = window.location.pathname;
            return path.split("/").pop();
        }

        // Function to get the next page link
        function getNextPageLink() {
            const currentPage = getCurrentPageName();
            const currentIndex = scores1.findIndex(item => item.link.includes(currentPage));
            // If currentIndex is not found or is the last item, loop to the first page or stay on the last page (up to your requirement)
            if (currentIndex === -1 || currentIndex === scores1.length - 1) {
                return "level3"; // Redirect to 'level1.html' if last item or not found
            } else {
                return scores1[currentIndex + 1].link; // Get the next page link
            }
        }

        // Modify the "Next" button's onclick event
        document.getElementById('next-button').onclick = function () {
            const nextPageLink = getNextPageLink();
            window.location.href = nextPageLink;
        };
    </script>
</body>

</html>